# Quality Gate 결과: F-08 웹 브리핑 뷰어 + F-12 인증 (Supabase Auth)

**검증일**: 2026-02-28  
**검증 브랜치**: main  
**검증 대상**: F-08 웹 브리핑 뷰어, F-12 인증 (Supabase Auth)

---

## 보안

### F-12 인증 보안

- Warning: Open Redirect 검증 미적용 — `/api/auth/telegram/route.ts` L127의 `redirectPath = searchParams.get('redirect') ?? '/'` 및 `/api/auth/callback/route.ts` L56의 `new URL(next, request.url)` 에서 외부 URL(예: `https://attacker.com`)이 `redirect` / `next` 파라미터로 전달될 경우 외부 도메인으로 리다이렉트된다. 현재 동일 origin 검증 로직 없음. 1인 서비스이지만 공개 엔드포인트이므로 개선 권장.
  - 해당 파일: `/Users/jsong/dev/jsong1230-github/Cortex/app/api/auth/telegram/route.ts:127`, `/Users/jsong/dev/jsong1230-github/Cortex/app/api/auth/callback/route.ts:56`
  - 권장 수정: `new URL(redirectPath, request.url).origin === new URL(request.url).origin` 검증 추가

- Warning: `admin.auth.listUsers()` 전체 사용자 목록 로드 — `/api/auth/telegram/route.ts` L80에서 사용자 조회 시 `admin.auth.listUsers()`로 전체 사용자 목록을 메모리에 로드한 뒤 `find()` 수행. 1인 서비스이므로 현재는 문제 없으나, Supabase Admin API의 `getUserByEmail(telegramEmail)` 또는 `listUsers({ filter: 'email=...' })` 방식이 더 효율적이고 안전.
  - 해당 파일: `/Users/jsong/dev/jsong1230-github/Cortex/app/api/auth/telegram/route.ts:79-89`

- Warning: 단일 사용자 제한 검증 미구현 — 설계서(docs/specs/F-12-auth/design.md §9.4)에서 "텔레그램 ID가 허용 목록(`TELEGRAM_CHAT_ID`)과 일치하는지 추가 검증 가능"으로 명시되어 있으나 실제 코드에는 구현되지 않음. 현재는 유효한 텔레그램 계정이라면 누구든 로그인 가능.
  - 해당 파일: `/Users/jsong/dev/jsong1230-github/Cortex/app/api/auth/telegram/route.ts`

- 통과: 텔레그램 hash 검증 — HMAC-SHA256 + `crypto.timingSafeEqual` 사용으로 타이밍 공격 방지 구현
- 통과: auth_date 만료 검증 — 24시간 초과 시 401 반환
- 통과: TELEGRAM_BOT_TOKEN 서버 전용 — 클라이언트 코드에 노출 없음
- 통과: SUPABASE_SERVICE_ROLE_KEY 서버 전용 — `lib/supabase/server.ts`에서만 사용
- 통과: dangerouslySetInnerHTML 미사용 — 전체 컴포넌트 검색 결과 없음
- 통과: 미들웨어 인증 — `getUser()` 사용 (getSession보다 안전한 서버측 검증)
- 통과: 쿠키 기반 세션 — `@supabase/ssr`의 SSR 클라이언트 패턴 준수

### F-08 브리핑 API 보안

- 통과: `/api/briefings/today` 인증 검증 — `getAuthUser()` 호출, 미인증 시 401 반환
- 통과: `/api/interactions` 인증 검증 — `getAuthUser()` 호출, 미인증 시 401 반환
- 통과: interaction 타입 화이트리스트 검증 — `VALID_INTERACTIONS` 배열로 허용값 제한
- 통과: RLS 정책 — `003_rls_policies.sql`에서 모든 테이블 RLS 활성화 및 정책 설정

### 의존성 취약점

- Warning: Next.js 14.2.35 버전에 고위험 CVE 2건 존재
  - `GHSA-9g9p-9gw9-jx7f`: self-hosted Image Optimizer remotePatterns DoS
  - `GHSA-h25m-26qc-wcjf`: HTTP request deserialization DoS (RSC 사용 시)
  - 수정 권고: Next.js 15.x 이상으로 업그레이드 (단, 호환성 검토 필요)

---

## 성능

### F-08 백엔드 성능

- 통과: N+1 쿼리 방지 — `content_items`와 `user_interactions` 모두 `in(contentIds)` 단일 쿼리로 일괄 조회
- 통과: 필요 컬럼만 SELECT — `id, title, summary_ai, source, source_url, tags` 명시적 선택
- Warning: 클라이언트 캐싱 미적용 — 설계서 §7에서 "클라이언트 stale-time 5분 적용" 권고하였으나 `BriefingCardList.tsx`에서 `useEffect` + `fetch` 단순 호출만 사용, `stale-time` / `Cache-Control` 헤더 미구현. React Query 등 도입 또는 응답 헤더 추가 권장.
  - 해당 파일: `/Users/jsong/dev/jsong1230-github/Cortex/components/briefing/BriefingCardList.tsx`

### F-08 프론트엔드 성능

- 통과: 스켈레톤 UI — 로딩 중 CLS 방지를 위한 스켈레톤 컴포넌트 구현
- 통과: 불필요한 Client Component 최소화 — 인터랙션이 필요한 컴포넌트만 `'use client'` 선언

---

## 설계/문서 일치

### F-08 설계 일치

- 설계 불일치: `BriefingData.briefing_id` 필드 불일치 — `BriefingCardList.tsx` L22에서 응답 타입에 `briefing_id: string` 필드를 기대하나, `GET /api/briefings/today` 응답 형식(route.ts L162-168)에는 `briefing_id`가 포함되지 않음 (`id`로 반환됨). 실제 API 응답의 `data.briefing_id`가 `undefined`가 되어 `BriefingCard`에 빈 문자열이 전달될 수 있음.
  - 해당 파일: `/Users/jsong/dev/jsong1230-github/Cortex/components/briefing/BriefingCardList.tsx:22`, `/Users/jsong/dev/jsong1230-github/Cortex/app/api/briefings/today/route.ts:162`
  - 설계서 응답 스펙: `briefing_date` + `items` 배열만 명시 (`briefing_id` 없음)
  - 테스트 데이터 `SAMPLE_BRIEFING.id`가 있으나 API 응답에는 `id` 필드 미포함

- 통과: 카드 구조 — 설계서 §4.1의 BriefingCard 속성(contentId, briefingId, channel, title, summaryAi, source, sourceUrl, reason, userInteraction) 모두 구현
- 통과: ChannelBadge 색상 — 설계서 §4.2 테이블과 구현 색상값 일치 확인
- 통과: FeedbackButtons 색상 — 설계서 §4.3 테이블과 구현 색상값 일치 확인
- 통과: AppShell 구조 — 설계서 §2.2의 컴포넌트 계층과 일치
- 통과: 사용자 반응 쿼리 불일치 — 설계서 §5.3에서 `DISTINCT ON` 쿼리를 명시하나, 실제 코드는 `in(...)` 조회 후 Map 첫 번째 항목 사용. 동일 효과를 애플리케이션 레이어에서 처리하며 결과는 동일.

### F-12 설계 일치

- 통과: 인증 흐름 — 설계서 §2.1의 흐름(미들웨어 → 로그인 → 텔레그램 콜백 → 세션 발급 → 리다이렉트)과 구현 일치
- 통과: hash 검증 알고리즘 — 설계서 §4.2의 HMAC-SHA256 알고리즘 그대로 구현
- 통과: 라우트 보호 매칭 — 설계서 §3.1 테이블과 `middleware.ts`의 matcher 패턴 일치
- 통과: 환경변수 노출 정책 — 설계서 §7의 서버/클라이언트 분리 정책 준수

### 중복 파일 (케밥케이스/파스칼케이스 공존)

- Warning: `components/briefing/` 디렉토리에 동일 기능의 파일이 케밥케이스/파스칼케이스로 중복 존재
  - `briefing-card.tsx` + `BriefingCard.tsx`
  - `channel-badge.tsx` + `ChannelBadge.tsx`
  - `feedback-buttons.tsx` + `FeedbackButtons.tsx`
  - 실제 임포트는 파스칼케이스 버전 사용 확인. 케밥케이스 파일이 구버전인지 확인 후 정리 필요.

---

## 인수조건 충족

### F-08 인수조건

- 인수조건 충족: AC1 — `/` 라우트(`app/(web)/page.tsx`)에서 `BriefingCardList` 컴포넌트가 `/api/briefings/today`를 호출하여 채널별 카드 표시 구현
- 인수조건 충족: AC2 — 최대 너비 640px, 단일 컬럼 레이아웃(`app/(web)/layout.tsx` L49), 모바일 헤더/하단탭 구조
- 인수조건 충족: AC3 — `BriefingCard.tsx`에서 [채널 뱃지][소스][제목][AI 요약][피드백 버튼 행] 모두 렌더링
- 인수조건 충족: AC4 — `FeedbackButtons.tsx`에서 낙관적 업데이트(즉시 상태 변경 후 API 호출, 실패 시 복구) 구현
- 인수조건 충족: AC5 — `BriefingCard.tsx` L109-124에서 `reason` prop이 있을 때만 힌트 영역 렌더링

### F-12 인수조건

- 인수조건 충족: AC1 — Supabase Auth 세션 기반 로그인(`/api/auth/telegram` → `/api/auth/callback`) 및 로그아웃(`/api/auth/logout`) 구현
- 인수조건 충족: AC2 — `TelegramLoginButton.tsx`에서 텔레그램 Login Widget 동적 로드, `/api/auth/telegram`에서 hash 검증 후 Supabase 사용자 연동
- 인수조건 충족: AC3 — `middleware.ts`에서 미인증 사용자를 `/login?redirect={pathname}`으로 리다이렉트
- 인수조건 미충족: AC4 — `features.md` F-12 AC4 "RLS 정책이 설정되어 본인 데이터만 조회 가능하다"에서 `003_rls_policies.sql`의 RLS 정책이 `auth.role() = 'authenticated'` 기반으로만 되어 있어 인증된 모든 사용자가 타인의 `user_interactions`, `briefings` 데이터를 읽을 수 있음. 1인 서비스이므로 현실적 위험은 없으나 요구사항 문자 그대로는 미충족.

---

## 시각 검증

- 생략: 개발 서버 미실행 상태로 시각 검증 생략 (ui-spec.md 미확인)

---

## 종합 판정

- FAIL: Critical 0건, Warning 5건 — 아래 항목 수정 권고

### Warning 목록 (우선순위 순)

1. **[F-12 보안]** Open Redirect 검증 미적용 — `/api/auth/callback/route.ts:56`, `/api/auth/telegram/route.ts:127`에 동일 origin 검증 추가
2. **[F-08 설계]** `briefing_id` API 응답 누락 — `GET /api/briefings/today` 응답에 `briefing_id` 추가 또는 `BriefingCardList.tsx` 타입/로직 수정
3. **[의존성]** Next.js 14.2.35 고위험 CVE 2건 — 버전 업그레이드 검토
4. **[F-12 보안]** 단일 사용자 제한 미검증 — `TELEGRAM_CHAT_ID` 기반 허용 목록 검증 추가
5. **[F-08 성능]** 클라이언트 캐싱 미적용 — 브리핑 응답 5분 stale-time 적용 검토
6. **[파일 정리]** 중복 파일 정리 — `components/briefing/` 케밥케이스 파일 삭제 또는 통일

### 잘 구현된 항목

- 텔레그램 hash 검증의 `timingSafeEqual` 타이밍 공격 방어
- N+1 쿼리 방지 (`in(...)` 일괄 조회)
- 낙관적 업데이트 + API 실패 시 원상 복구 패턴
- `@supabase/ssr` SSR 쿠키 패턴 올바른 적용
- TypeScript strict 모드 준수 (소스 파일 기준)
- 서버/클라이언트 환경변수 분리 철저
- 단위 테스트 + 통합 테스트 커버리지 충분 (F-08, F-12 모두)
