# F-01~F-04 수집기 테스트 결과 보고서

- 날짜: 2026-02-28 00:33
- 단계: Phase 2 — 구현 완료 후 전체 검증
- 실행자: QA Engineer (claude-sonnet-4-6)

---

## 요약

| 항목 | 값 |
|------|-----|
| 테스트 파일 | 9개 |
| 전체 테스트 수 | 169개 |
| PASSED | 169개 |
| FAILED | 0개 |
| 소요 시간 | 1.48s |

---

## 테스트 파일별 결과

### 기존 테스트 (회귀 확인)

| 파일 | 테스트 수 | 결과 |
|------|-----------|------|
| `tests/unit/date.test.ts` | 5 | 전체 PASS |
| `tests/unit/alerts.test.ts` | 3 | 전체 PASS |

### 신규 테스트 (F-01~F-04)

| 파일 | 테스트 수 | 결과 | 대상 기능 |
|------|-----------|------|-----------|
| `tests/unit/collectors/hackernews.test.ts` | 9 | 전체 PASS | F-01: HN 수집기 |
| `tests/unit/collectors/github.test.ts` | 10 | 전체 PASS | F-01: GitHub Trending 수집기 |
| `tests/unit/collectors/rss.test.ts` | 8 | 전체 PASS | F-01: RSS 수집기 |
| `tests/unit/collectors/tech-collector.test.ts` | 12 | 전체 PASS | F-01: TechCollector 오케스트레이터 |
| `tests/unit/collectors/world-collector.test.ts` | 29 | 전체 PASS | F-02: WorldCollector 오케스트레이터 |
| `tests/unit/collectors/culture-collector.test.ts` | 47 | 전체 PASS | F-03: CultureCollector 오케스트레이터 |
| `tests/unit/collectors/toronto-collector.test.ts` | 46 | 전체 PASS | F-04: TorontoCollector 오케스트레이터 |

---

## 테스트 커버리지 상세

### F-01: TECH 채널 수집기

#### collectHackerNews (9개 테스트)
- 정상 응답 시 상위 10개를 스코어 내림차순으로 반환한다
- 모든 아이템의 channel이 tech이다
- 모든 아이템의 source가 hackernews이다
- url이 있는 아이템의 source_url은 해당 url이다
- url이 없는 아이템의 source_url은 HN 토론 페이지 URL이다
- published_at은 Unix 타임스탬프를 Date 객체로 변환한다
- title이 없는 아이템은 결과에서 제외된다
- topstories API 실패 시 에러를 throw한다
- 개별 아이템 fetch 실패 시 해당 건만 제외하고 나머지에서 상위 10개를 반환한다

#### collectGitHubTrending (10개 테스트)
- 정상 HTML 파싱 시 최대 20개를 반환한다
- 모든 아이템의 channel이 tech이다
- 모든 아이템의 source가 github_trending이다
- source_url은 https://github.com/owner/repo 형식이다
- title은 owner/repo: description 형식이다
- 설명이 없는 리포의 title에는 설명 없음이 포함된다
- 언어 태그를 추출한다
- 언어가 없는 리포의 tags는 빈 배열이다
- HTTP 오류 시 에러를 throw한다
- HTML 구조 변경으로 셀렉터가 매칭되지 않을 때 빈 배열을 반환한다

#### collectRssFeed / collectMultipleRssFeeds (8개 테스트)
- 정상 RSS 파싱 시 RssCollectedItem 배열을 반환한다
- limit 옵션 적용 시 지정된 수만큼만 반환한다
- link가 없는 아이템은 결과에서 제외된다
- pubDate가 있는 아이템의 publishedAt은 유효한 Date 객체이다
- pubDate가 없는 아이템의 publishedAt은 undefined이다
- 3개 피드 모두 성공 시 합산된 아이템을 반환한다
- 일부 피드 실패 시 성공한 피드 데이터만 반환하고 console.error를 호출한다
- 모든 피드 실패 시 빈 배열을 반환하고 console.error를 3회 호출한다

#### TechCollector + safeCollect (12개 테스트)
- TechCollector name/channel 속성 검증
- 3개 소스 모두 성공, 부분 실패, 전체 실패 시나리오
- 병렬 실행 성능 (~100ms)
- CollectorResult.channel === 'tech' 검증
- safeCollect 정상/throw/reject 케이스

### F-02: WORLD 채널 수집기 (29개 테스트)

#### WorldCollector
- name/channel 속성 검증
- 7개 RSS 피드 모두 성공 케이스
- 일부/전체 피드 실패 케이스
- 모든 아이템 channel='world' 검증
- source 매핑 검증
- naver_politics -> politics 태그 검증
- 아이템 200개 -> 상위 15개 이하 선별 검증

#### scoreByCrossSourceAppearance (8개 테스트)
- 3개 소스 등장 시 crossSourceScore >= 3
- 단일 소스 crossSourceScore === 1
- 유사 제목 동일 이슈 판정
- 완전히 다른 제목 다른 이슈 판정
- crossSourceScore 내림차순 정렬
- 동일 점수 시 최신 published_at 우선
- 빈 배열/단일 아이템 경계값

#### extractCategoryTag (8개 테스트)
- naver_politics -> politics
- naver_economy -> economy
- naver_society -> society
- naver_it -> it_science
- daum_news -> general
- yonhap -> general
- bbc_korea -> international
- 미등록 소스 -> 빈 배열

#### collectMultipleRssFeeds WORLD 연동 (4개 테스트)
- 7개 피드 설정 병렬 호출 확인
- 네이버 정치 RSS limit=20 설정 확인
- 다음 뉴스 RSS limit=50 설정 확인
- 연합뉴스 RSS limit=100 설정 확인

### F-03: CULTURE 채널 수집기 (47개 테스트)

#### collectNaverRealtime (8개 테스트)
- 정상 응답, channel, source, source_url 날짜, title, tags 검증
- HTML 구조 변경 빈 배열, 네트워크 오류 throw 검증

#### collectNaverDatalabTrend (6개 테스트)
- TOP 10 이하 반환, NAVER_CLIENT_ID/SECRET 미설정 빈 배열
- 401 인증 실패 throw, source/tags 검증

#### collectNetflixTop1 (7개 테스트)
- 1위만 반환, channel, source, title 형식, tags 검증
- HTML 파싱 실패 빈 배열, 404 throw

#### collectMelonChart (9개 테스트)
- TOP 5 반환, channel, source, title 형식, source_url songId
- User-Agent 헤더 검증, 403 throw, HTML 구조 변경 빈 배열, tags

#### collectYouTubeTrendingTop2 (9개 테스트)
- 상위 2개 반환, channel, source, source_url 형식, published_at Date
- API_KEY 미설정 빈 배열, 403 throw, 빈 items 배열, full_text 500자 제한

#### CultureCollector (8개 테스트)
- name/channel 속성 검증
- 5개 소스 모두 성공 케이스
- 부분 실패(넷플릭스+멜론), 전체 실패 케이스
- 환경변수 미설정 소스 빈 결과 처리
- 병렬 실행 성능 (~100ms)
- 모든 아이템 channel='culture' 검증

### F-04: TORONTO 채널 수집기 (46개 테스트)

#### filterTorontoNews (11개 테스트)
- toronto 키워드 우선 순위, 대소문자 무시
- ontario/ttc/gta/york region 키워드 판정
- 비관련 기사 후순위 배치, limit 적용
- 빈 배열 경계값, 전체 toronto, 전체 비관련

#### TorontoCollector.collectTorontoStar() (9개 테스트)
- 상위 2개 반환, 토론토 키워드 우선 배치
- channel, source, tags toronto/canada 분기
- 0개 아이템, RSS 오류 에러 기록

#### TorontoCollector.collectCBC() (5개 테스트)
- 상위 2개 반환, 토론토 키워드 우선 배치
- channel, source 검증, RSS 오류 에러 기록

#### TorontoCollector.collectWeather() (10개 테스트)
- 날씨 아이템 1개 반환, channel, source 검증
- source_url 오늘 날짜 포함
- title '[토론토 날씨] conditionKr temperatureC (체감 feelsLikeC)' 형식
- full_text 습도/풍속 포함, tags=['weather','toronto']
- OPENWEATHER_API_KEY 미설정 에러, 401/500 API 오류 에러

#### collect() 오케스트레이터 (7개 테스트)
- 3개 소스 모두 성공: items 5개 + errors 0개
- Toronto Star 실패: items 3개 + errors 1개
- 날씨 실패: items 4개 + errors 1개
- 3개 소스 전체 실패: items 0개 + errors 3개
- 병렬 실행 성능 (~100ms)
- 모든 아이템 channel='canada'

#### inferTags() (4개 테스트)
- toronto/ontario 키워드 -> ['toronto']
- 일반 캐나다 키워드 -> ['canada']
- 대소문자 무시 매칭

---

## 신규 생성 파일 목록

### 타입 및 유틸리티
- `/Users/jsong/dev/jsong1230-github/Cortex/lib/collectors/types.ts`
  - Channel, CollectedItem, CollectorError, CollectorResult, ContentCollector 인터페이스
- `/Users/jsong/dev/jsong1230-github/Cortex/lib/collectors/utils.ts`
  - safeCollect() — 개별 소스 실패 격리 유틸리티

### 수집기 구현
- `/Users/jsong/dev/jsong1230-github/Cortex/lib/collectors/hackernews.ts`
- `/Users/jsong/dev/jsong1230-github/Cortex/lib/collectors/github.ts`
- `/Users/jsong/dev/jsong1230-github/Cortex/lib/collectors/rss.ts`
- `/Users/jsong/dev/jsong1230-github/Cortex/lib/collectors/tech-collector.ts`
- `/Users/jsong/dev/jsong1230-github/Cortex/lib/collectors/world-collector.ts`
- `/Users/jsong/dev/jsong1230-github/Cortex/lib/collectors/culture-collector.ts`
- `/Users/jsong/dev/jsong1230-github/Cortex/lib/collectors/toronto-collector.ts`
- `/Users/jsong/dev/jsong1230-github/Cortex/lib/collectors/toronto-news.ts`

### 테스트 파일
- `/Users/jsong/dev/jsong1230-github/Cortex/tests/unit/collectors/hackernews.test.ts`
- `/Users/jsong/dev/jsong1230-github/Cortex/tests/unit/collectors/github.test.ts`
- `/Users/jsong/dev/jsong1230-github/Cortex/tests/unit/collectors/rss.test.ts`
- `/Users/jsong/dev/jsong1230-github/Cortex/tests/unit/collectors/tech-collector.test.ts`
- `/Users/jsong/dev/jsong1230-github/Cortex/tests/unit/collectors/world-collector.test.ts`
- `/Users/jsong/dev/jsong1230-github/Cortex/tests/unit/collectors/culture-collector.test.ts`
- `/Users/jsong/dev/jsong1230-github/Cortex/tests/unit/collectors/toronto-collector.test.ts`

---

## 회귀 테스트 결과

기존 테스트 8개 (date.test.ts 5개, alerts.test.ts 3개) 모두 PASS.
신규 수집기 테스트 작성 및 구현으로 인한 기존 기능 회귀 없음.

---

## 기술적 특이사항

### rss-parser 모킹 전략
`rss-parser`는 클래스 기반 모듈이며 `rss.ts`에서 모듈 로드 시 `new Parser({...})`로 인스턴스를 생성합니다.
`vi.mock()` 팩토리가 호이스팅되어 테스트 파일의 변수 초기화보다 먼저 실행되는 제약을 `vi.hoisted()`로 해결했습니다.

```typescript
const parseURLSpy = vi.hoisted(() => vi.fn());

vi.mock('rss-parser', () => {
  return {
    default: class MockParser {
      constructor(_opts?: unknown) {}
      parseURL = parseURLSpy;
    },
  };
});
```

### culture-collector.test.ts 모킹 전략
외부 의존성(naver, netflix, melon, youtube) 5개를 `vi.hoisted()` + `vi.mock()` 조합으로 격리하여
CultureCollector 오케스트레이터 로직만 순수하게 테스트합니다.

### 병렬 실행 성능 테스트
TechCollector, CultureCollector, TorontoCollector 모두 Promise.all 병렬 실행을 검증합니다.
각 소스가 100ms 지연 시 전체 소요 시간 < 300ms (단순 합산 300ms 대비 병렬 약 100ms).

---

## Quality Gate 결과 (F-01 ~ F-04 수집기)

- 검증일: 2026-02-28
- 검증자: quality-gate (claude-sonnet-4-6)

### 보안

- Warning: `lib/collectors/rss.ts` 86번 라인에 `console.error`가 RSS 피드 실패 시 `result.reason`을 그대로 로그에 출력합니다. `result.reason`에 URL, 인증 토큰 등 민감 정보가 포함될 수 있습니다. 에러 메시지만 추출(`result.reason?.message`)하여 출력하도록 변경을 권장합니다.
- Warning: `lib/collectors/youtube.ts`의 `collectYouTubeTrending` (하위 호환용 레거시 함수) 에서 `YOUTUBE_DATA_API_KEY` 미설정 시 `console.error`를 사용합니다. 코딩 컨벤션상 `console.log` / `console.error` 금지 규칙이 있으나 수집기 레이어에서 로깅이 필요하므로 구조화된 로거 도입을 권장합니다.
- Warning: `lib/collectors/naver.ts`의 `collectNaverDatalabTrend`에서 `NAVER_CLIENT_ID / NAVER_CLIENT_SECRET` 미설정 시 `console.warn`을 사용합니다. 동일한 컨벤션 이슈입니다.
- Info: cheerio HTML 파싱 결과는 서버 사이드에서만 처리되어 dangerouslySetInnerHTML에 노출되지 않습니다. XSS 위험 없음.
- Info: 환경변수(API 키)는 `process.env`에서만 참조하며 하드코딩된 시크릿 없음. 정상.
- Info: 모든 외부 URL은 코드에 상수로 정의되어 사용자 입력에 의한 SSRF 위험 없음. 정상.
- Info: GitHub Trending, Melon, Netflix 파싱 시 User-Agent 헤더 설정 확인. 정상.

### 성능

- Warning: `lib/collectors/hackernews.ts`에서 개별 HN 아이템 50개를 `Promise.allSettled`로 병렬 fetch합니다. 동시 연결 50개가 발생하며 HN Firebase API의 Rate-Limit 정책에 따라 429 오류가 발생할 수 있습니다. 동시 실행 수를 제한하는 concurrency 제어(`p-limit` 라이브러리 등)를 권장합니다.
- Warning: `lib/collectors/rss.ts`의 RSS 파서 인스턴스(`parser`)가 모듈 레벨 싱글턴으로 선언되어 있습니다. 서버리스(Vercel) 환경에서 cold start마다 새로 생성되므로 문제없으나, 타임아웃 옵션(10초)이 `collectMultipleRssFeeds` 병렬 호출 시 전체 최악 소요 시간에 영향을 줄 수 있습니다.
- Info: TechCollector / CultureCollector / TorontoCollector 모두 `Promise.all`로 소스를 병렬 실행합니다. 설계서 의도와 일치하며 테스트에서도 검증됨. 정상.
- Info: WorldCollector는 `collectMultipleRssFeeds` 내부에서 `Promise.allSettled`로 7개 피드를 병렬 수집합니다. 정상.
- Info: `scoreByCrossSourceAppearance`는 O(n²) 알고리즘입니다. 현재 최대 입력이 240개(7피드 * 최대 약 240건)로 허용 범위 내입니다.

### 설계/문서 일치

- 설계 불일치 (Warning): F-01 design.md 섹션 3.3에서 RSS 피드당 수집량 `limit: 5`로 명시했으나, `lib/collectors/tech-collector.ts`의 `TECH_RSS_FEEDS`는 초기 빈 배열이므로 현재 적용되지 않습니다. 향후 사용자 RSS 추가 시 limit 값이 설계서(5)와 다르게 적용될 수 있습니다. `TECH_RSS_FEEDS` 설정에 `limit: 5` 기본값 명시를 권장합니다.
- 설계 불일치 (Info): F-01 design.md 섹션 5.3에서 `full_text`가 `[description, language].filter(Boolean).join(' | ')` 형태로 명시되어 있으나, 실제 구현(`lib/collectors/github.ts` 43번 라인)은 `[description, language].filter(Boolean).join(' | ') || undefined`를 사용합니다. description과 language 모두 없을 때 undefined를 반환하는 미묘한 차이가 있으나 설계 의도와 일치합니다.
- 설계 불일치 (Warning): F-02 design.md 섹션 6에서 `WorldCollector.extractCategoryTag`를 private 메서드로 설계했으나, 실제 구현에서는 `extractCategoryTag`를 모듈 레벨 함수로 export하고 private 메서드 `extractCategoryTagInternal`을 추가로 정의했습니다 (`lib/collectors/world-collector.ts` 150번 라인). private 메서드가 사용되지 않는 dead code입니다.
- 설계 불일치 (Warning): F-04 design.md 섹션 5에서 `collectTorontoStar`, `collectCBC`, `collectWeather`, `rssToCollectedItem`, `inferTags` 메서드를 모두 `private`으로 설계했으나, 실제 구현(`lib/collectors/toronto-collector.ts`)에서 `collectTorontoStar`, `collectCBC`, `collectWeather`, `inferTags`가 `public` 접근 제어자로 구현되어 있습니다. 설계 의도와 다릅니다.
- 설계 불일치 (Info): F-04 design.md의 `full_text`에 `최고/최저 {temp_max}/{temp_min}C` 포함이 명시되어 있으나 실제 구현(`lib/collectors/toronto-collector.ts` 81번 라인)에서는 `습도 ${humidity}% | 풍속 ${windSpeed}m/s`만 포함하고 최고/최저 기온이 누락되어 있습니다.
- 인수조건 충족: F-01 AC1 (HN 50개 수집 -> 10개 선별) — 구현 및 테스트 통과.
- 인수조건 충족: F-01 AC2 (GitHub Trending 20개 수집) — 구현 및 테스트 통과.
- 인수조건 충족: F-01 AC3 (사용자 RSS 최신 5개) — TECH_RSS_FEEDS 빈 배열로 현재 비활성. 설계서 명시됨.
- 인수조건 충족: F-01 AC6 (개별 소스 실패 시 독립 진행) — safeCollect 패턴 적용. 테스트 통과.
- 인수조건 충족: F-02 AC4 (교차 소스 이슈 가중치) — scoreByCrossSourceAppearance 구현. 테스트 통과.
- 인수조건 충족: F-03 AC1~AC5 (5개 문화 소스 수집) — 구현 및 테스트 통과.
- 인수조건 충족: F-04 AC1~AC3 (Toronto Star/CBC/날씨 수집) — 구현 및 테스트 통과.
- 인수조건 미충족 (Warning): F-04 AC3에서 "현재기온/최고/최저/날씨상태" 수집이 명시되어 있으나 `collectWeather`의 `full_text`에 최고/최저 기온이 포함되지 않습니다.
- 인수조건 미충족 (Info): F-01 AC4, F-02 AC5, F-03 AC6, F-04 AC5 — content_items 테이블 저장은 수집기 범위 밖(F-05/cron route)이므로 수집기 레이어에서는 해당 없음. 정상.

### 코드 품질

- Warning: `lib/collectors/rss.ts`에 `RSS_FEEDS` 전역 배열이 여전히 존재하며 world/canada 채널 URL을 중복 정의합니다. `world-collector.ts`의 `WORLD_RSS_FEEDS`와 `toronto-collector.ts`의 `TORONTO_RSS_FEEDS`로 분리되었으나 `rss.ts`의 `RSS_FEEDS`가 제거되지 않았습니다. 설계서에서 이동 지시가 있었으나 미완료 상태입니다.
- Warning: `lib/collectors/world-collector.ts` 150번 라인의 `extractCategoryTagInternal` private 메서드는 실제로 사용되지 않는 dead code입니다. 제거를 권장합니다.
- Warning: `lib/collectors/youtube.ts`에 `collectYouTubeTrending` (레거시)와 `collectYouTubeTrendingTop2` 두 함수가 중복 구현되어 있습니다. 두 함수의 내부 로직이 동일하며 `selectLimit` 처리만 다릅니다. 레거시 함수 제거 또는 내부 공통 함수로 리팩토링을 권장합니다.
- Warning: `lib/collectors/naver.ts`에 `NAVER_REALTIME_URL` 상수가 선언되어 있으나 실제 `collectNaverRealtime` 함수에서는 `'https://www.naver.com'`을 직접 하드코딩하여 사용하고 있습니다 (17번 라인). 상수가 실제로 사용되지 않습니다.
- Info: TypeScript 인터페이스 및 타입 정의가 설계서와 일치합니다. `CollectedItem`, `CollectorError`, `CollectorResult`, `ContentCollector` 모두 정상.
- Info: 에러 핸들링 패턴이 `safeCollect` 래퍼로 일관성 있게 적용되었습니다. 정상.
- Info: 테스트 169개 전체 PASS. 핵심 시나리오(정상/부분실패/전체실패/병렬실행) 커버.

### 시각 검증

- 생략: ui-spec.md 없음 (수집기 백엔드 레이어로 UI 없음)

### 종합 판정

- FAIL: Critical 이슈 0건, Warning 이슈 9건 — Warning 수정 후 재검증 권장

#### 주요 수정 권고 우선순위

1. (Warning) `lib/collectors/rss.ts` 86번 라인 에러 로그 민감정보 노출 방지
2. (Warning) `lib/collectors/hackernews.ts` 동시 fetch 50개 concurrency 제어 추가
3. (Warning) `lib/collectors/world-collector.ts` dead code `extractCategoryTagInternal` 제거
4. (Warning) `lib/collectors/toronto-collector.ts` collectTorontoStar/collectCBC/collectWeather/inferTags를 private으로 변경 (설계서 일치)
5. (Warning) `lib/collectors/toronto-collector.ts` `full_text`에 최고/최저 기온 추가 (F-04 AC3, design.md 일치)
6. (Warning) `lib/collectors/rss.ts` 전역 `RSS_FEEDS` 배열 제거 (world-collector, toronto-collector로 완전 이동)
7. (Warning) `lib/collectors/youtube.ts` 레거시 `collectYouTubeTrending` 중복 코드 정리
8. (Warning) `lib/collectors/naver.ts` 미사용 `NAVER_REALTIME_URL` 상수 정리
9. (Warning) 전체 수집기 `console.error/warn` → 구조화된 로거 교체 검토
