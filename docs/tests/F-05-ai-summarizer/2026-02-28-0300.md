# F-05 AI 요약/스코어링 Quality Gate 결과

- 날짜: 2026-02-28 03:00
- 검증자: quality-gate (claude-sonnet-4-6)
- 대상 브랜치: main

---

## 테스트 실행 결과

| 항목 | 값 |
|------|-----|
| 테스트 파일 (F-05 신규) | 3개 (summarizer.test.ts, scoring.test.ts, cron-collect.test.ts) |
| F-05 신규 테스트 수 | 33개 |
| 전체 테스트 수 (회귀 포함) | 202개 |
| PASSED | 202개 |
| FAILED | 0개 |
| 소요 시간 | 8.65s |

---

## Quality Gate 결과: F-05 AI 요약/스코어링

### 보안

- Warning: `lib/summarizer.ts` `selectWorldItems` 함수(424번 라인)에서 Claude 응답 JSON을 타입 단언(`as WorldSelectionResponse`)으로 파싱합니다. `parsed.selected`가 배열인지는 검증하지만 배열 원소가 숫자인지 필터링하는 검증이 중복됩니다 (validIndices 단계에서 `typeof idx === 'number'`를 체크하므로 기능적으로는 안전). 그러나 `parsed.reason`은 `typeof`를 통해 문자열 여부를 확인하고 있어 방어적 파싱이 일관되게 적용되어 있습니다.
- Info: ANTHROPIC_API_KEY가 환경변수에서만 참조되며 코드에 하드코딩된 키/토큰 없음. 정상.
- Info: `.env.local`이 `.gitignore`의 `.env.*` 패턴으로 커버되어 Git에 포함되지 않음. `.env.example`은 `.gitignore`에서 명시적으로 제외(`!.env.example`)하여 예시 파일은 커밋됨. 정상.
- Info: CRON_SECRET을 `Authorization: Bearer {secret}` 헤더로 검증하여 Cron 엔드포인트 무단 접근 방지. 정상.
- Info: 시스템 프롬프트는 하드코딩된 상수(`SYSTEM_PROMPT`)이며 사용자 입력이 삽입되지 않음. 프롬프트 인젝션 경로는 `items[].title`, `items[].fullText`이나, 이 값들은 DB에서 조회된 수집기 결과이므로 사용자 직접 입력과 다름. 프롬프트 내 JSON 직렬화(`JSON.stringify`)로 특수문자가 이스케이프됨. 잠재적 위험 낮음.
- Info: Claude API 응답의 `summary`, `tags`, `score` 값은 타입 검증 후 DB에 저장되어 XSS 노출 경로 없음. 정상.
- Info: `console.info`가 `logUsage` 함수에서 사용되며 `eslint-disable-next-line no-console` 주석으로 명시적 예외 처리. 토큰/비용 통계만 로깅하며 민감 데이터 미포함. 정상.

### 성능

- Warning: `lib/summarizer.ts` `callClaudeAPI` 함수(153번 라인)에서 호출마다 `createAnthropicClient()`를 호출하여 매번 새로운 Anthropic 인스턴스를 생성합니다. 재시도 시 2회 인스턴스가 생성됩니다. 모듈 수준 싱글턴으로 유지하거나 함수 외부에서 인스턴스를 전달하는 방식이 경량화에 유리합니다. 현재 규모(일 5~7회 호출)에서는 성능 영향 미미.
- Warning: `summarizeAndScore`의 `SummarizeStats.cached` 필드가 항상 0으로 고정됩니다(371번 라인). design.md 섹션 6.1의 캐싱 로직(DB에서 `summary_ai IS NULL` 아이템만 조회)이 cron/collect/route.ts의 TODO 블록에 미구현 상태이므로, 캐시 카운트가 실제로 집계되지 않습니다. 기능 자체는 DB 쿼리로 보장되지만 통계 정확도가 낮습니다.
- Info: `summarizeAndScore`에서 채널별 병렬 호출에 `Promise.allSettled`를 사용합니다. 설계서 섹션 11.3의 병렬 호출 전략과 일치. 정상.
- Info: `buildBatchPrompt`에서 `fullText.slice(0, 500)` 적용으로 토큰 절약. 설계서 섹션 8.2와 일치. 정상.
- Info: 재시도 대기 시간이 테스트 환경에서 0ms로 단축(`RETRY_DELAY_MS = process.env.NODE_ENV === 'test' ? 0 : 2000`), 프로덕션 환경에서는 2초 대기. 설계서 7.3과 일치. 정상.
- Info: design.md 섹션 11.1 예상 총 소요 시간 ~90초이며 30분 제약(AC7)을 충분히 만족. 구조적으로 설계서 의도와 일치. 정상.

### 설계/문서 일치

- 설계 불일치: `cron/collect/route.ts`에서 채널별 수집기 병렬 실행(TODO 블록 54-64번 라인)과 Supabase INSERT/SELECT/UPDATE 로직(86-100번 라인 TODO)이 미구현 상태입니다. design.md 섹션 10의 전체 흐름 중 단계 [2]수집기 실행, [3]INSERT, [5]SELECT(summary_ai IS NULL)가 스텁으로 남아있습니다. F-05 자체 구현(summarizer.ts)은 완성되었으나 파이프라인 연결이 부분적입니다.
- 설계 불일치: `lib/scoring.ts`에 design.md 섹션 4.2.1에서 명시된 `calculateTechScore` 함수가 구현되어 있으나, `updateInterestScore`와 `calculateContentScore` 두 함수는 Phase 2 TODO 상태입니다. 이는 Phase 1 설계 의도와 일치하므로 경고 아닌 정보성 사항입니다.
- 설계 불일치 (Warning): design.md 섹션 7.2 에러 유형별 처리 표에서 "Claude API 429 (Rate Limit)" 케이스에 5초 대기 후 재시도를 지정했으나, 실제 `callClaudeAPI`는 HTTP 상태 코드를 구분하지 않고 모든 에러에 2초 대기 단일 재시도를 적용합니다. 429와 네트워크 에러가 동일하게 처리됩니다.
- 설계 불일치 (Info): design.md 섹션 5.4에서 WORLD 채널 요약 시 "점수는 고정 0.8"을 명시했으나, 실제 구현은 WORLD 선정 후 일반 `summarizeAndScore`로 요약하며 Claude가 직접 점수를 반환합니다. 고정 0.8 적용 로직이 없습니다. 기능적으로는 허용 가능하나 설계서 명시 내용과 다릅니다.
- 인수조건 충족 (AC1): `summarizeAndScore`에서 Claude API를 호출하여 각 아이템에 대해 `summaryAi` (한국어 요약)을 생성합니다. 시스템 프롬프트에 "요약은 반드시 한국어로 작성, 1~2문장, 80자 이내" 규칙이 명시됩니다. 테스트 U-01~U-04 통과.
- 인수조건 충족 (AC2): TECH 채널 프롬프트에 관심도x0.6 + 실무적용x0.3 + 최신성x0.1 가중치 기준이 텍스트로 포함됩니다. Phase 1에서는 Claude가 이 기준을 반영하여 scoreInitial을 직접 반환. 테스트 U-23 통과.
- 인수조건 충족 (AC3): `selectWorldItems` 함수가 "40~50대 직장인이 알아야 할 이슈" 기준으로 최대 2개를 선정합니다. 테스트 U-16~U-19 통과.
- 인수조건 충족 (AC4): CULTURE 채널 프롬프트에 "플랫폼 순위 + 검색량 기반" 점수 기준 명시. 테스트 U-24 통과.
- 인수조건 충족 (AC5): TORONTO 채널 프롬프트에 "뉴스 중요도 + 날씨 고정 포함(0.9 이상)" 기준 명시. 테스트 U-04, U-25 통과.
- 인수조건 충족 (AC6): DB에서 `summary_ai IS NULL` 아이템만 조회하는 캐싱 로직이 설계서에 명시되어 있고, cron route의 TODO 주석으로 구현 예정이 표시됨. summarizer.ts 자체는 입력된 아이템을 모두 처리하며 캐싱은 상위 레이어(cron route)에서 담당하는 구조로 설계와 일치. 단, 현재 cron route에 Supabase 조회가 미구현으로 캐싱이 실제 동작하지 않음.
- 인수조건 미충족 (AC6): cron/collect/route.ts의 Supabase DB 연동 (`summary_ai IS NULL` 아이템 조회 및 요약 결과 UPDATE)이 TODO 블록으로 미구현. 캐싱이 실제로 동작하지 않음.
- 인수조건 충족 (AC7): 설계서 섹션 11.1에서 전체 파이프라인 예상 소요 시간을 ~90초로 분석하여 30분 이내 충족을 설계적으로 보장. 실제 DB 연동 완료 후 측정 필요.

### 시각 검증

- 생략: ui-spec.md 없음 (백엔드/서버 사이드 기능으로 UI 없음)

### 종합 판정

- FAIL: Critical 이슈 0건, Warning 이슈 3건 — Warning 수정 후 재검증 권장

#### 주요 수정 권고 우선순위

1. (Warning, 인수조건 미충족 AC6) `cron/collect/route.ts` Supabase DB 연동 구현 — `summary_ai IS NULL` 아이템 조회, 요약 결과 UPDATE, 캐시 카운트 집계
2. (Warning, 설계 불일치) `callClaudeAPI`에 HTTP 상태 코드 기반 분기 처리 추가 — 429 응답 시 5초 대기 (design.md 7.2 에러 유형별 처리표 일치)
3. (Warning, 설계 불일치) WORLD 채널 선정 후 요약 시 `scoreInitial`을 0.8로 고정하는 로직 추가 (design.md 5.4)
4. (Info) `callClaudeAPI` 호출 시 매번 `createAnthropicClient()` 신규 인스턴스 생성 — 모듈 레벨 지연 초기화(lazy singleton)로 변경 권장

