# F-07 í…”ë ˆê·¸ë¨ ë´‡ ëª…ë ¹ì–´ ì²˜ë¦¬ â€” API ìŠ¤í™ í™•ì •ë³¸

**ë²„ì „**: 1.0 | **ë‚ ì§œ**: 2026-02-28 | **ìƒíƒœ**: í™•ì •
**ë‹´ë‹¹**: backend-dev
**ì°¸ì¡°**: docs/specs/F-07-telegram-commands/design.md, docs/system/api-conventions.md

---

## ì—”ë“œí¬ì¸íŠ¸

### POST `/api/telegram/webhook`

í…”ë ˆê·¸ë¨ ì„œë²„ì—ì„œ ë´‡ ë©”ì‹œì§€ ë° ì¸ë¼ì¸ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì‹ í•œë‹¤.

#### ì¸ì¦

```
í—¤ë”: X-Telegram-Bot-Api-Secret-Token: {TELEGRAM_WEBHOOK_SECRET}
```

ê²€ì¦ ì‹¤íŒ¨ ì‹œ 401 ë°˜í™˜. í…”ë ˆê·¸ë¨ ë´‡ ë“±ë¡ ì‹œ `setWebhook` APIì˜ `secret_token` íŒŒë¼ë¯¸í„°ë¡œ ì„¤ì •í•œ ê°’ê³¼ ì¼ì¹˜í•´ì•¼ í•œë‹¤.

#### ìš”ì²­ í˜•ì‹

Content-Type: `application/json`
Body: Telegram Update ê°ì²´

**ë©”ì‹œì§€ ëª…ë ¹ì–´ ìš”ì²­ ì˜ˆì‹œ:**
```json
{
  "update_id": 123456789,
  "message": {
    "message_id": 1,
    "from": { "id": 12345, "first_name": "jsong" },
    "chat": { "id": 12345, "type": "private" },
    "date": 1740700000,
    "text": "/good"
  }
}
```

**ì¸ë¼ì¸ ë²„íŠ¼ ì½œë°± ìš”ì²­ ì˜ˆì‹œ:**
```json
{
  "update_id": 123456790,
  "callback_query": {
    "id": "cq-001",
    "from": { "id": 12345, "first_name": "jsong" },
    "data": "like:550e8400-e29b-41d4-a716-446655440000"
  }
}
```

#### ì‘ë‹µ

**ì„±ê³µ ì‘ë‹µ (200 OK):**
```json
{ "success": true }
```

**ì¸ë¼ì¸ ì½œë°± ì„±ê³µ ì‘ë‹µ (200 OK):**
```json
{
  "success": true,
  "data": {
    "type": "callback_query",
    "action": "like:550e8400-e29b-41d4-a716-446655440000"
  }
}
```

**ì¸ì¦ ì‹¤íŒ¨ ì‘ë‹µ (401 Unauthorized):**
```json
{ "success": false, "error": "Unauthorized" }
```

> **ì¤‘ìš”**: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì˜¤ë¥˜(ë¸Œë¦¬í•‘ ì—†ìŒ, DB ì˜¤ë¥˜ ë“±)ëŠ” ëª¨ë‘ 200ìœ¼ë¡œ ë°˜í™˜í•œë‹¤. 4xx/5xx ë°˜í™˜ ì‹œ í…”ë ˆê·¸ë¨ì´ ë™ì¼ ë©”ì‹œì§€ë¥¼ ì¬ì „ì†¡í•˜ê¸° ë•Œë¬¸ì´ë‹¤.

---

## ì§€ì› ëª…ë ¹ì–´

### /good (AC1)

**ë™ì‘**: ë§ˆì§€ë§‰ ë¸Œë¦¬í•‘ ì „ì²´ ì•„ì´í…œì— 'ì¢‹ì•„ìš”' ë°˜ì‘ì„ user_interactionsì— ì €ì¥í•œë‹¤.

**ì²˜ë¦¬ íë¦„**:
1. `briefings` í…Œì´ë¸”ì—ì„œ ìµœì‹  ë¸Œë¦¬í•‘ ì¡°íšŒ (ORDER BY briefing_date DESC LIMIT 1)
2. `items` JSONBì˜ ê° content_idì— ëŒ€í•´ `user_interactions` INSERT
3. í…”ë ˆê·¸ë¨ìœ¼ë¡œ ì„±ê³µ ë©”ì‹œì§€ ë°œì†¡

**ì‘ë‹µ ë©”ì‹œì§€ (í…”ë ˆê·¸ë¨)**: `"ë¸Œë¦¬í•‘ì— ì¢‹ì•„ìš”ë¥¼ ë‚¨ê²¼ìŠµë‹ˆë‹¤! ì˜¤ëŠ˜ ë¸Œë¦¬í•‘ì´ ë§ˆìŒì— ë“œì…¨êµ°ìš” ğŸ˜Š"`
**ë¸Œë¦¬í•‘ ì—†ìŒ**: `"ì•„ì§ ë¸Œë¦¬í•‘ì´ ì—†ìŠµë‹ˆë‹¤. ë‚´ì¼ ì•„ì¹¨ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!"`

---

### /bad (AC2)

**ë™ì‘**: ë§ˆì§€ë§‰ ë¸Œë¦¬í•‘ ì „ì²´ ì•„ì´í…œì— 'ì‹«ì–´ìš”' ë°˜ì‘ ê¸°ë¡ + í›„ì† í‚¤ì›Œë“œ ì§ˆë¬¸ ë°œì†¡.

**ì²˜ë¦¬ íë¦„**: /goodê³¼ ë™ì¼í•˜ë‚˜ `interaction='ì‹«ì–´ìš”'`.

**ì‘ë‹µ ë©”ì‹œì§€**:
```
ë¸Œë¦¬í•‘ì— ì‹«ì–´ìš”ë¥¼ ë‚¨ê²¼ìŠµë‹ˆë‹¤.
ì–´ë–¤ ì£¼ì œê°€ ë³„ë¡œì˜€ë‚˜ìš”? /keyword ëª…ë ¹ì–´ë¡œ ê´€ì‹¬ ì—†ëŠ” ì£¼ì œë¥¼ ì•Œë ¤ì£¼ì‹œë©´ í•™ìŠµì— ë°˜ì˜í• ê²Œìš”.
ì˜ˆ) /keyword ì£¼ì‹
```

---

### /save N (AC3)

**ë™ì‘**: ì˜¤ëŠ˜ ë¸Œë¦¬í•‘ Në²ˆì§¸(1-based) ì•„ì´í…œì„ 'ì €ì¥' ë°˜ì‘ìœ¼ë¡œ ê¸°ë¡í•œë‹¤.

**ì¸ì**: N â€” 1 ì´ìƒì˜ ì •ìˆ˜

**ì²˜ë¦¬ íë¦„**:
1. ì˜¤ëŠ˜ ë‚ ì§œ(KST) ê¸°ì¤€ `briefings` ì¡°íšŒ
2. `items` JSONBì—ì„œ `position === N`ì¸ ì•„ì´í…œì˜ `content_id` ì¶”ì¶œ
3. `user_interactions` INSERT (`interaction='ì €ì¥'`)

**ì‘ë‹µ ë©”ì‹œì§€**: `"Në²ˆì§¸ ì•„ì´í…œì„ ì €ì¥í–ˆìŠµë‹ˆë‹¤! /history ë˜ëŠ” ì›¹ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”."`
**ìœ íš¨í•˜ì§€ ì•Šì€ N**: `"ìœ íš¨í•˜ì§€ ì•Šì€ ë²ˆí˜¸ì…ë‹ˆë‹¤. /save 1 í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”."`

---

### /more (AC4)

**ë™ì‘**: ì˜¤ëŠ˜ ë¸Œë¦¬í•‘ ì›¹ ìƒì„¸ í˜ì´ì§€ URLì„ í…”ë ˆê·¸ë¨ìœ¼ë¡œ ë°œì†¡í•œë‹¤.

**ì‘ë‹µ ë©”ì‹œì§€**:
```
ì˜¤ëŠ˜ ë¸Œë¦¬í•‘ ì›¹ ìƒì„¸ í˜ì´ì§€:
{NEXT_PUBLIC_APP_URL}/briefings/{YYYY-MM-DD}
```

---

### /keyword XXX (AC5)

**ë™ì‘**: ê´€ì‹¬ í‚¤ì›Œë“œë¥¼ `interest_profile` í…Œì´ë¸”ì— ì¦‰ì‹œ ì¶”ê°€í•œë‹¤.

**ì¸ì**: XXX â€” í‚¤ì›Œë“œ í…ìŠ¤íŠ¸ (ê³µë°± í¬í•¨ ê°€ëŠ¥)

**ì²˜ë¦¬ íë¦„**:
1. `interest_profile` UPSERT (ON CONFLICT topic):
   ```json
   { "topic": "XXX", "score": 0.7, "interaction_count": 1 }
   ```

**ì‘ë‹µ ë©”ì‹œì§€**: `"'XXX'ë¥¼ ê´€ì‹¬ í‚¤ì›Œë“œë¡œ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤! ë‹¤ìŒ ë¸Œë¦¬í•‘ë¶€í„° ë°˜ì˜ë¼ìš”."`
**ë¹ˆ í‚¤ì›Œë“œ**: `"í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. ì˜ˆ) /keyword LLM"`

---

### /stats (AC6)

**ë™ì‘**: ì´ë²ˆ ë‹¬ ê´€ì‹¬ í† í”½ Top 5ì™€ ì½ì€ ì•„í‹°í´ ìˆ˜ë¥¼ í…”ë ˆê·¸ë¨ìœ¼ë¡œ ë°œì†¡í•œë‹¤.

**ì²˜ë¦¬ íë¦„**:
1. `interest_profile`ì—ì„œ score ê¸°ì¤€ ìƒìœ„ 5ê°œ ì¡°íšŒ
2. `user_interactions`ì—ì„œ ì´ë²ˆ ë‹¬(ì›” 1ì¼~í˜„ì¬) `interaction IN ('ì¢‹ì•„ìš”', 'ì €ì¥', 'ë§í¬í´ë¦­', 'ì›¹ì—´ê¸°')` ê±´ìˆ˜ ì§‘ê³„

**ì‘ë‹µ ë©”ì‹œì§€ í˜•ì‹**:
```
ğŸ“Š ì´ë²ˆ ë‹¬ í†µê³„ (YYYYë…„ Mì›”)

ğŸ”¥ ê´€ì‹¬ í† í”½ Top 5:
1. LLM (ê´€ì‹¬ë„ 8.5)
2. Kubernetes (ê´€ì‹¬ë„ 7.2)
...

ğŸ“š ì½ì€ ì•„í‹°í´: Nê±´
```

---

### /mute N (AC7)

**ë™ì‘**: Nì¼ê°„ ë¸Œë¦¬í•‘ì„ ì¤‘ë‹¨í•œë‹¤. N=0ì´ë©´ ë®¤íŠ¸ í•´ì œ.

**ì¸ì**: N â€” 0 ì´ìƒì˜ ì •ìˆ˜ (0: í•´ì œ, 1+: ì¤‘ë‹¨ ì¼ìˆ˜)

**ì²˜ë¦¬ íë¦„**:
1. `alert_settings` UPSERT (ON CONFLICT trigger_type):
   ```json
   {
     "trigger_type": "briefing_mute",
     "is_enabled": true,
     "daily_count": N,
     "last_triggered_at": "now()"
   }
   ```

**ì‘ë‹µ ë©”ì‹œì§€**: `"Nì¼ê°„ ë¸Œë¦¬í•‘ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤. ë‹¤ì‹œ ë°›ìœ¼ë ¤ë©´ /mute 0 ì„ ì…ë ¥í•˜ì„¸ìš”."`
**ë®¤íŠ¸ í•´ì œ**: `"ë¸Œë¦¬í•‘ ìˆ˜ì‹ ì´ ì¬ê°œë©ë‹ˆë‹¤!"`

---

## ì¸ë¼ì¸ ë²„íŠ¼ ì½œë°± ì²˜ë¦¬

ë¸Œë¦¬í•‘ ë©”ì‹œì§€ì˜ ì¸ë¼ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ callback_queryë¡œ ìˆ˜ì‹ í•œë‹¤.

**ì½œë°± ë°ì´í„° í˜•ì‹**:
```
{action}:{content_id}
ì˜ˆ: like:550e8400-e29b-41d4-a716-446655440000
ì˜ˆ: dislike:550e8400-e29b-41d4-a716-446655440000
ì˜ˆ: save:550e8400-e29b-41d4-a716-446655440000
```

**action â†’ interaction ë§¤í•‘**:
| action | interaction |
|--------|------------|
| `like` | `ì¢‹ì•„ìš”` |
| `dislike` | `ì‹«ì–´ìš”` |
| `save` | `ì €ì¥` |

---

## ë„ì›€ë§

ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì–´ ì…ë ¥ ì‹œ ì•„ë˜ ë„ì›€ë§ì„ ë°œì†¡í•œë‹¤:

```
ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì–´: /{command}

ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:
/good â€” ì˜¤ëŠ˜ ë¸Œë¦¬í•‘ ì¢‹ì•„ìš”
/bad â€” ì˜¤ëŠ˜ ë¸Œë¦¬í•‘ ì‹«ì–´ìš” + í”¼ë“œë°±
/save N â€” Në²ˆì§¸ ì•„ì´í…œ ì €ì¥
/more â€” ì˜¤ëŠ˜ ë¸Œë¦¬í•‘ ì›¹ URL
/keyword XXX â€” ê´€ì‹¬ í‚¤ì›Œë“œ ì¶”ê°€
/stats â€” ì´ë²ˆ ë‹¬ í†µê³„
/mute N â€” Nì¼ê°„ ë¸Œë¦¬í•‘ ì¤‘ë‹¨
```

---

## ì—ëŸ¬ ì²˜ë¦¬ ì›ì¹™

| ìƒí™© | HTTP ìƒíƒœ | ì²˜ë¦¬ ë°©ì‹ |
|------|----------|----------|
| ì‹œí¬ë¦¿ í† í° ë¶ˆì¼ì¹˜ | 401 | ì¦‰ì‹œ ë°˜í™˜, ì²˜ë¦¬ ì¤‘ë‹¨ |
| JSON íŒŒì‹± ì‹¤íŒ¨ | 200 | ë¬´ì‹œ, 200 ë°˜í™˜ |
| Supabase ì˜¤ë¥˜ | 200 | ì•ˆë‚´ ë©”ì‹œì§€ ë°œì†¡, 200 ë°˜í™˜ |
| sendMessage ì‹¤íŒ¨ | 200 | ì—ëŸ¬ ë¡œê¹…, 200 ë°˜í™˜ |
| ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì–´ | 200 | ë„ì›€ë§ ë°œì†¡, 200 ë°˜í™˜ |

> í…”ë ˆê·¸ë¨ì€ ì›¹í›…ì—ì„œ 4xx/5xx ì‘ë‹µì„ ë°›ìœ¼ë©´ ë™ì¼ ë©”ì‹œì§€ë¥¼ ì¬ì „ì†¡í•˜ë¯€ë¡œ, ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì˜¤ë¥˜ëŠ” ë°˜ë“œì‹œ 200ìœ¼ë¡œ ë°˜í™˜í•œë‹¤.

---

## ê´€ë ¨ íŒŒì¼

| íŒŒì¼ | ì—­í•  |
|------|------|
| `app/api/telegram/webhook/route.ts` | ì›¹í›… ì—”ë“œí¬ì¸íŠ¸, ì¸ì¦ ê²€ì¦, ë¼ìš°íŒ… |
| `lib/telegram-commands.ts` | ëª…ë ¹ì–´ íŒŒì‹± ë° í•¸ë“¤ëŸ¬ êµ¬í˜„ |
| `lib/telegram.ts` | sendMessage, parseCallbackData ìœ í‹¸ë¦¬í‹° |
| `lib/supabase/server.ts` | Supabase ì„œë²„ í´ë¼ì´ì–¸íŠ¸ |

---

*F-07 API Spec v1.0 | 2026-02-28*
